<!--yml
category: 未分类
date: 0001-01-01 00:00:00
--->

# 为什么使用消息队列？

> 原文：[https://zwmst.com/1094.html](https://zwmst.com/1094.html)

   [ *消息队列* ](https://zwmst.com/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97)*[ <time datetime="2021-08-15T10:24:42+08:00"> 2021-08-15 </time> ](https://zwmst.com/1094.html)  **面试官心理分析**

其实面试官主要是想看看：

*   第一，你知不知道你们系统里为什么要用消息队列这个东西？

不少候选人，说自己项目里用了 Redis、MQ，但是其实他并不知道自己为什么要用这个 东西。其实说白了，就是为了用而用，或者是别人设计的架构，他从头到尾都没思考 过。

没有对自己的架构问过为什么的人，一定是平时没有思考的人，面试官对这类候选人印 象通常很不好。因为面试官担心你进了团队之后只会木头木脑的干呆活儿，不会自己思 考。

*   第二，你既然用了消息队列这个东西，你知不知道用了有什么好处&坏处？

你要是没考虑过这个，那你盲目弄个 MQ 进系统里，后面出了问题你是不是就自己溜了 给公司留坑？你要是没考虑过引入一个技术可能存在的弊端和风险，面试官把这类候选 人招进来了，基本可能就是挖坑型选手。就怕你干 1 年挖一堆坑，自己跳槽了，给公司留 下无穷后患。

*   第三，既然你用了 MQ，可能是某一种 MQ，那么你当时做没做过调研？

你别傻乎乎的自己拍脑袋看个人喜好就瞎用了一个 MQ，比如 Kafka，甚至都从没调研 过业界流行的 MQ 到底有哪几种。每一个 MQ 的优点和缺点是什么。每一个 MQ 没有绝 对的好坏，但是就是看用在哪个场景可以扬长避短，利用其优势，规避其劣势。

如果是一个不考虑技术选型的候选人招进了团队，leader 交给他一个任务，去设计个什 么系统，他在里面用一些技术，可能都没考虑过选型，最后选的技术可能并不一定合 适，一样是留坑。

**面试题剖析**

其实就是问问你消息队列都有哪些使用场景，然后你项目里具体是什么场景，说说你在这个场 景里用消息队列是什么？

面试官问你这个问题，期望的一个回答是说，你们公司有个什么业务场景，这个业务场景有个 什么技术挑战，如果不用 MQ 可能会很麻烦，但是你现在用了 MQ 之后带给了你很多的好处。

先说一下消息队列常见的使用场景吧，其实场景有很多，但是比较核心的有 3 个：解耦、异 步、削峰。

**解耦**

看这么个场景。A 系统发送数据到 BCD 三个系统，通过接口调用发送。如果 E 系统也要这个 数据呢？那如果 C 系统现在不需要了呢？A 系统负责人几乎崩溃……

![image-20210814191517000](img/d8152d6e45a76dde7753759c7f8c59db.png)

在这个场景中，A 系统跟其它各种乱七八糟的系统严重耦合，A 系统产生一条比较关键的数 据，很多系统都需要 A 系统将这个数据发送过来。A 系统要时时刻刻考虑 BCDE 四个系统如果 挂了该咋办？要不要重发，要不要把消息存起来？头发都白了啊！

如果使用 MQ，A 系统产生一条数据，发送到 MQ 里面去，哪个系统需要数据自己去 MQ 里面 消费。如果新系统需要数据，直接从 MQ 里消费即可；如果某个系统不需要这条数据了，就取 消对 MQ 消息的消费即可。这样下来，A 系统压根儿不需要去考虑要给谁发送数据，不需要维 护这个代码，也不需要考虑人家是否调用成功、失败超时等情况。

![image-20210814191530422](img/4f7befa45c737e60c6647f8513badcdf.png)

总结：通过一个 MQ，Pub/Sub 发布订阅消息这么一个模型，A 系统就跟其它系统彻底解耦 了。

面试技巧：你需要去考虑一下你负责的系统中是否有类似的场景，就是一个系统或者一个模 块，调用了多个系统或者模块，互相之间的调用很复杂，维护起来很麻烦。但是其实这个调用 是不需要直接同步调用接口的，如果用 MQ 给它异步化解耦，也是可以的，你就需要去考虑在 你的项目里，是不是可以运用这个 MQ 去进行系统的解耦。在简历中体现出来这块东西，用 MQ 作解耦。

**异步**

再来看一个场景，A 系统接收一个请求，需要在自己本地写库，还需要在 BCD 三个系统写 库，自己本地写库要 3ms，BCD 三个系统分别写库要 300ms、450ms、200ms。最终请求 总延时是 3 + 300 + 450 + 200 = 953ms，接近 1s，用户感觉搞个什么东西，慢死了慢死了。 用户通过浏览器发起请求，等待个 1s，这几乎是不可接受的。

![image-20210814191550645](img/4ca838eb6e52fc47245fd9061560a3a5.png)

一般互联网类的企业，对于用户直接的操作，一般要求是每个请求都必须在 200 ms 以内完 成，对用户几乎是无感知的。

如果使用 MQ，那么 A 系统连续发送 3 条消息到 MQ 队列中，假如耗时 5ms，A 系统从接受 一个请求到返回响应给用户，总时长是 3 + 5 = 8ms，对于用户而言，其实感觉上就是点个按 钮，8ms 以后就直接返回了，爽！网站做得真好，真快

![image-20210814191602862](img/fd80bd12a85dbba08efdf56e85a4145d.png)

**削峰**

每天 0:00 到 12:00，A 系统风平浪静，每秒并发请求数量就 50 个。结果每次一到 12:00 ~ 13:00 ，每秒并发请求数量突然会暴增到 5k+ 条。但是系统是直接基于 MySQL 的，大量的请 求涌入 MySQL，每秒钟对 MySQL 执行约 5k 条 SQL。

一般的 MySQL，扛到每秒 2k 个请求就差不多了，如果每秒请求到 5k 的话，可能就直接把 MySQL 给打死了，导致系统崩溃，用户也就没法再使用系统了。

但是高峰期一过，到了下午的时候，就成了低峰期，可能也就 1w 的用户同时在网站上操作， 每秒中的请求数量可能也就 50 个请求，对整个系统几乎没有任何的压力。

![image-20210814191623027](img/c8abcf641663c2bc424d84a2806d0b06.png)

如果使用 MQ，每秒 5k 个请求写入 MQ，A 系统每秒钟最多处理 2k 个请求，因为 MySQL 每 秒钟最多处理 2k 个。A 系统从 MQ 中慢慢拉取请求，每秒钟就拉取 2k 个请求，不要超过自己 每秒能处理的最大请求数量就 ok，这样下来，哪怕是高峰期的时候，A 系统也绝对不会挂掉。 而 MQ 每秒钟 5k 个请求进来，就 2k 个请求出去，结果就导致在中午高峰期（1 个小时），可 能有几十万甚至几百万的请求积压在 MQ 中。

![image-20210814191637646](img/fa4d09615e6bc6e1e2b746d81e02dd37.png)

这个短暂的高峰期积压是 ok 的，因为高峰期过了之后，每秒钟就 50 个请求进 MQ，但是 A 系 统依然会按照每秒 2k 个请求的速度在处理。所以说，只要高峰期一过，A 系统就会快速将积 压的消息给解决掉。*